/*! JobManager - v1.0 - 2013-07-21 6:03:31 PM
* Copyright (c) 2013 xuejia.cxj; Licensed  */
KISSY.add("/kissy-gallery/JobManager/1.0/build/index",function(a,b,c){function d(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)}).toUpperCase()}function e(a){var b=[];for(attr in a)a.hasOwnProperty(attr)&&b.push(attr);return b}function f(a,b){function c(a){if(!a)return!1;var b,c=h.length;for(b=0;c>b;b++)if(h[b]===a)return!0;return!1}function d(){var b=Math.random()*f-.001<<0;return a[b]}if(!a instanceof Array)return[];for(var e,f=a.length,b=Math.min(f,b),g=0,h=[];b>g;)e=d(),c(e)||(g+=1,h.push(e));return h}function g(a){var b=this;return!b instanceof g?new g(arguments):(b.parent=g,b.workers={},b.conf={stratergy:"random",maxworker:100,workerClass:{klass:null,staticDomContainers:[],params:null}},b._init(),g.superclass.constructor.call(b,a),void 0)}b.all;var h=null,i=null,j=null,k={bind:function(a,b){var c=a.split(" ");this._callbacks||(this._callbacks={});for(var d=0;d<c.length;d++)(this._callbacks[c[d]]||(this._callbacks[c[d]]=[])).push(b);return this},trigger:function(){var a,b,c,d,e=Array.prototype.slice.call(arguments,0),f=e.shift();if(!(b=this._callbacks))return this;if(!(a=this._callbacks[f]))return this;for(c=0,d=a.length;d>c;c++)a[c].apply(this,e);return this},remove:function(a){return this._callbacks?this._callbacks[a]?(this._callbacks[a]=[],void 0):this:this},unbind:function(a,b){if(!a)return this._callbacks={},this;var c,d,e,f;if(!(d=this._callbacks))return this;if(!(c=this._callbacks[a]))return this;for(e=0,f=c.length;f>e;e++)if(b===c[e]){c.splice(e,1);break}return this}};return h={_init:function(){var a=this;console.log("init Manager");for(attr in k)a[attr]=k[attr];a.Stratergy={random:function(){a.runRandom()}},a._bindJobEvents()},runRandom:function(){var a=this,b=a.workers;a._generateWorkQueue();var c=a.workerQueue;if(0!=c.length){var d,e,f;for(d=0,e=c.length;e>d;d++)f=c[d],worker=b[f[0]],worker.work(f,a)}},run:function(){var a=this,b=a.conf.stratergy||"random";return a.Stratergy[b](),a},stop:function(){},reStore:function(){var a=this;0===a.conf.workerClass.staticDomContainers.length},hasJob:function(){var a,b,c=this,d=c.workerQueue;for(a=0;l>a;a++)if(b=d[a],b[1]!=b[3])return!0;return!1},config:function(a){var b=this;for(attr in a)b.conf[attr]=a[attr];return b},addWorker:function(a){var b=this,c=b.makeWorker(a);return b.workers[c.id]=c,b},removeWorker:function(){var a=this;return delete a.workers[""],a},_generateWorkQueue:function(){function a(){var a={},c=b.workers;for(attr in c)if(c.hasOwnProperty(attr)){var d=c[attr];d.isElInViewPort?d.isElInViewPort()&&(a[attr]=""):a[attr]=""}return a}var b=this,c=b.get("workerRange"),d=b.get("workTimeRange"),b=this,g=e(a()),h=[];console.log("InviewPort: "+g.length);var i,j,k=Math.floor(Math.random()*(c[1]-c[0])+c[0]),l=f(g,Math.min(k,g.length));for(i=0,j=l.length;j>i;i++){var m=Math.floor(Math.random()*(d[1]-d[0])+d[0]);h.push([l[i],m,0])}return b.workerQueue=h,console.log(b.get("workTimeRange")),console.log(h[0]),b.jobFinished=0,h},_bindJobEvents:function(){var a=this;a.bind("finishOneRound",function(){a._generateWorkQueue(),console.log("finish a one ROund"),a.run()}),a.bind("finishedAJob",function(){a.jobFinished+=1,a.jobFinished==a.workerQueue.length&&a.trigger("finishOneRound")})},makeWorker:function(a){"function"!=typeof a.work&&(a.work=function(){}),a.id=d();var b=a.interval||1e3;return a.work=function(a,c){function d(){e=setTimeout(function(){f.timesToRun>0?(f.run(),f.timesToRun-=1,d()):(c.trigger("finishedAJob",a),clearTimeout(e))},b)}var e,f=this;f.timesToRun=a[1],d()},a}},i={stratergy:"random",maxworker:100,workerClass:{klass:null,staticDomContainers:[],params:null},workerRange:[2,4],workTimeRange:[1,3]},j=function(){var a=this;a.attr="haha",a.interval=2e3,a.run=function(){var a=this;console.log(a.id||a.attr)},a.work=function(){var a=this;setTimeOut(a.run(),a.interval)}},a.extend(g,c,h,{ATTRS:i,TestWorker:j}),g},{requires:["node","base"]});